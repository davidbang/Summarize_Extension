!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,(b.extensionSkeleton||(b.extensionSkeleton={})).exports=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){!function(){function b(a,b,c){console.log(a+": context = "+b+", tabId = "+c)}function c(){console.log('===== will broadcast "hello world!" in 10 seconds'),setTimeout(function(){console.log('>>>>> broadcasting "hello world!" now'),e.bcast("echo","hello world!",function(){console.log("<<<<< broadcasting done")})},1e4),setTimeout(c,3e5)}console.log("BACKGROUND SCRIPT WORKS!");var d=a("./modules/handlers").create("bg");d.onConnect=b.bind(null,"onConnect"),d.onDisconnect=b.bind(null,"onDisconnect");var e=a("./modules/msg").init("bg",d);c()}()},{"./modules/handlers":2,"./modules/msg":3}],2:[function(a,b,c){function d(){console.log.apply(console,arguments)}b.exports.create=function(a){return{random:function(b){d("---> "+a+"::random() invoked");var c=Math.floor(1e3*Math.random());d("<--- returns: "+c),b(c)},randomAsync:function(b){d("---> "+a+"::randomAsync() invoked (15 sec delay)"),setTimeout(function(){var a=Math.floor(1e3*Math.random());d("<--- returns: "+a),b(a)},15e3)},echo:function(b,c){d("---> "+a+'::echo("'+b+'") invoked'),d("<--- (no return value)"),c()}}},b.exports.__resetLog=function(){d=function(){}}},{}],3:[function(a,b,c){function d(a,b){if("function"==typeof b){var c={};for(var d in a)a.hasOwnProperty(d)&&(c[d]=b(d,a[d],a));return c}}function e(){this.handlers={},this.id=null,this.port=null,this.extPorts={},this.cbTable={},this.pendingReqs={},this.uId=1,this.requestId=1,this.portMap={},this.runtime=h,this.devtools=i}function f(a,b){a.__setRuntime=function(c){return b.runtime=c,a},a.__setDevTools=function(c){return b.devtools=c,a},a.__getId=function(){return b.id},a.__getPort=function(){return b.port},a.__getPortMap=function(){return b.portMap},a.__getHandlers=function(){return b.handlers},a.__getPendingReqs=function(){return b.pendingReqs}}var g=-1e3,h="object"==typeof chrome&&chrome.runtime,i="object"==typeof chrome&&chrome.devtools;e.prototype.selectTargets=function(a,b,c,e,f){var h=[],i=this.portMap[e]&&this.portMap[e][f];return a||i?(a||b!==g||(b=i.tabId),d(this.portMap,function(e,f){c&&-1===c.indexOf(e)||d(f,function(c,d){b&&b!==d.tabId||(a||i.port!==d.port)&&h.push({port:d.port,id:c})})}),h):[]},e.prototype.onCustomMsg=function(a){function b(b){a.sendResponse&&this.port.postMessage({cmd:"response",portId:this.id,reqId:a.reqId,resultValid:!0,result:b})}function c(b){var c=[],e=this.runtime.id;return function(f,g){if(g!==!1&&c.push(f),b--,!b&&a.sendResponse&&((d=this.extPorts[a.extensionId])||this.portMap[a.category]&&(d=this.portMap[a.category][a.portId]))){var h={cmd:"response",reqId:a.reqId,result:a.broadcast?c:c[0]};a.extensionId&&(h.extensionId=e),d.port.postMessage(h)}}.bind(this)}var d,e,f,g,h;if(a&&a.cmd){if("setName"===a.cmd)return void(this.id=a.name);if("bg"===this.id){if("request"===a.cmd){var i=this.selectTargets(!1,a.tabId,a.contexts,a.category,a.portId),j=i.length;if(void 0!==a.tabId||a.contexts&&-1===a.contexts.indexOf("bg")||(g=this.handlers[a.cmdName])&&"function"==typeof g&&(f=g,j++),j){var k=c.call(this,j);for(h=0;h<i.length;h++)d=i[h],d.port.postMessage({cmd:"request",cmdName:a.cmdName,sendResponse:!0,args:a.args,reqId:this.requestId}),e=this.pendingReqs[d.id]||[],e.push({id:this.requestId,cb:k}),this.pendingReqs[d.id]=e,this.requestId++;f&&(a.args.push(k),f.apply(this.handlers,a.args))}else if(a.sendResponse&&((d=this.extPorts[a.extensionId])||this.portMap[a.category]&&(d=this.portMap[a.category][a.portId]))){var l={cmd:"response",reqId:a.reqId,resultValid:!1,result:a.broadcast?[]:void 0};a.extensionId&&(l.extensionId=this.runtime.id),d.port.postMessage(l)}}else if("response"===a.cmd){var m=a.portId||a.extensionId;if(e=this.pendingReqs[m]){for(h=0;h<e.length&&e[h].id!==a.reqId;)h++;h<e.length&&(e[h].cb(a.result,a.resultValid),this.pendingReqs[m].splice(h,1),this.pendingReqs[m].length||delete this.pendingReqs[m])}}else if("updateTabId"===a.cmd){var n=a.context,o=a.portId;(d=this.portMap[n])&&(d=d[o])&&("function"==typeof this.handlers.onDisconnect&&this.handlers.onDisconnect(n,d.tabId),d.tabId=a.tabId,"function"==typeof this.handlers.onConnect&&this.handlers.onConnect(n,d.tabId))}}else"request"===a.cmd?(f=this.handlers[a.cmdName],"function"!=typeof f?a.sendResponse&&this.port.postMessage({cmd:"response",portId:this.id,reqId:a.reqId,resultValid:!1}):(a.args.push(b.bind(this)),f.apply(this.handlers,a.args))):"response"===a.cmd&&this.cbTable[a.reqId]&&(this.cbTable[a.reqId](a.result),delete this.cbTable[a.reqId])}},e.prototype.closePendingReqs=function(a){var b;if(b=this.pendingReqs[a]){for(var c=0;c<b.length;c++)b[c].cb(void 0,!1);delete this.pendingReqs[a]}},e.prototype.registerExternalConnection=function(a,b){function c(){b.onDisconnect.removeListener(e),b.onMessage.removeListener(d),delete this.extPorts[a],this.closePendingReqs(a),"function"==typeof this.handlers.onExtensionDisconnect&&this.handlers.onExtensionDisconnect(a)}this.extPorts[a]={port:b};var d,e;b.onMessage.addListener(d=this.onCustomMsg.bind(this)),b.onDisconnect.addListener(e=c.bind(this)),"function"==typeof this.handlers.onExtensionConnect&&this.handlers.onExtensionConnect(a)},e.prototype.onConnectExternal=function(a){this.extPorts[a.sender.id]||this.registerExternalConnection(a.sender.id,a)},e.prototype.onConnect=function(a){function b(){a.onDisconnect.removeListener(h),a.onMessage.removeListener(g),e=this.portMap[c];var b;e&&(b=e[d])&&(f=b.tabId,delete e[d]),this.closePendingReqs(d),"function"==typeof this.handlers.onDisconnect&&this.handlers.onDisconnect(c,f)}var c=a.name||"unknown",d=c+"-"+this.uId;this.uId++;var e=this.portMap[c]||{},f=a.sender&&a.sender.tab&&a.sender.tab.id||1/0;e[d]={port:a,tabId:f},this.portMap[c]=e;var g,h;a.onMessage.addListener(g=this.onCustomMsg.bind(this)),a.onDisconnect.addListener(h=b.bind(this)),a.postMessage({cmd:"setName",name:d}),"function"==typeof this.handlers.onConnect&&this.handlers.onConnect(c,f)},e.prototype.createMsgObject=function(a){function b(b){function c(a,c){var d=[];return function(e,f){f&&d.push(e),a--,0>=a&&c&&c(b?d:d[0])}}return function d(){if(!arguments.length)return!1;if(!this.id){var e=this,f=arguments;return setTimeout(function(){d.apply(e,f)},1),!0}var g,h,i,j,k=[],l=0,m=arguments.length;for("function"==typeof arguments[m-1]&&(m--,j=arguments[m]);m>l;){var n=arguments[l++];if(void 0===i)switch(typeof n){case"number":if(void 0!==g)return!1;g=n;break;case"object":if("undefined"==typeof n.length||void 0!==h)return!1;h=n;break;case"string":i=n;break;default:return!1}else k.push(n)}if(void 0===i)return!1;if("bg"===this.id){for(var o=this.selectTargets(!0,g,h),p=o.length,q=c.call(this,p,j),r=0;r<o.length;r++){var s=o[r];s.port.postMessage({cmd:"request",cmdName:i,sendResponse:!0,args:k,reqId:this.requestId});var t=this.pendingReqs[s.id]||[];t.push({id:this.requestId,cb:q}),this.pendingReqs[s.id]=t,this.requestId++}o.length||q(null,!1)}else j&&(this.cbTable[this.requestId]=j),this.port.postMessage({cmd:"request",cmdName:i,reqId:this.requestId,sendResponse:void 0!==j,broadcast:b,category:a,portId:this.id,tabId:g,contexts:h,args:k}),this.requestId++;return!0}.bind(this)}function c(){return function(a,b){if(arguments.length<2)return!1;if("bg"!==this.id)return!1;var c,d=Array.prototype.slice.call(arguments,2);"function"==typeof d[d.length-1]&&(c=d.pop());var e=this.extPorts[a];if(!e)return c&&c(),!0;e.port.postMessage({cmd:"request",cmdName:b,sendResponse:!0,args:d,reqId:this.requestId,extensionId:this.runtime.id});var f=this.pendingReqs[a]||[];return f.push({id:this.requestId,cb:function(a){c&&c(a)}}),this.pendingReqs[a]=f,this.requestId++,!0}.bind(this)}var d={cmd:b.call(this,!1),bcast:b.call(this,!0)};return"bg"!==a?d.bg=function(){if(0===arguments.length||"string"!=typeof arguments[0])return!1;for(var a=[["bg"]],b=0;b<arguments.length;b++)a.push(arguments[b]);return d.cmd.apply(d,a)}:(d.connectExt=function(a){if(this.extPorts[a])return!0;var b=this.runtime.connect(a);this.registerExternalConnection(a,b)}.bind(this),d.cmdExt=c.call(this)),d},e.prototype.init=function(a,b){function c(){this.port.onDisconnect.removeListener(e),this.port.onMessage.removeListener(f)}function d(){return this.id?void this.port.postMessage({cmd:"updateTabId",context:a,portId:this.id,tabId:g}):void setTimeout(d.bind(this),1)}this.handlers=b||{};var e,f,g;return"bg"===a?(this.id="bg",this.runtime.onConnect.addListener(this.onConnect.bind(this)),this.runtime.onConnectExternal.addListener(this.onConnectExternal.bind(this))):(this.port=this.runtime.connect({name:a}),this.port.onMessage.addListener(f=this.onCustomMsg.bind(this)),this.port.onDisconnect.addListener(e=c.bind(this)),"dt"===a&&this.devtools&&(g=this.devtools.inspectedWindow)&&"number"==typeof(g=g.tabId)&&d.call(this)),this.createMsgObject(a)};var j=new e;b.exports={SAME_TAB:g,init:j.init.bind(j),__allowUnitTests:function(){f(this,j)},__createClone:function(){var a=new e;return a.SAME_TAB=g,f(a,a),a}}},{}]},{},[1])(1)});